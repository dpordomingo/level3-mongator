<?php
    protected $document;
    protected $level3;

    public function __construct(\Level3\Level3 $level3)
    {
        $this->level3 = $level3;
    }

    public function fromDocument(\{{ class }} $document)
    {
        $this->setDataFromDocument($document);
        $this->setResourcesFromDocument($document);
        $this->setLinksFromDocument($document);
    }

    public function fromDocuments(Array $documents)
    {
        $repository = $this->level3->getHub()->get('{{ extension.getRepositoryKey(class)}}');
        foreach ($documents as $document) {
            $resource = $repository->createDocumentResource($document);  
            $this->addResource('{{ config_class.key }}', $resource);
        }
    }

    protected function setDataFromDocument(\{{ class }} $document)
    {
        $data = array();

{# fields #}
{% if extension.isRepositoryNeeded(class) %}
        $mongoId = (string) $document->getId();
        $data['id'] = {{ extension.getTypeToResponse('MongoId') }}

{% endif %}
{% for name, config in config_class.fields %}
{% if 'referenceField' not in config|keys %}
{% if extension.hasType(config.type) %}

        $data['{{ name }}'] = ${{ config.type }} = $document->get{{name|ucfirst}}();
        if (${{ config.type }}) {
            $data['{{ name }}'] = {{ extension.getTypeToResponse(config.type) }}
        }

{% else %}
        $data['{{ name }}'] = $document->get{{name|ucfirst}}();
{% endif %}
{% endif %}
{% endfor %}

        $this->setData($data);
    }
    
    protected function setResourcesFromDocument(\{{ class }} $document)
    {
{# embeddedsOne #}
{% for name, config in config_class.embeddedsOne %}
        if (${{ name }} = $document->get{{ name|ucfirst }}()) {
            $this->addResource('{{ name }}', $this->create{{ name|ucfirst }}EmbeddedResource(${{ name }}));
        }

{% endfor %}
{# embeddedsMany #}
{% for name, config in config_class.embeddedsMany %}
        foreach($document->get{{ name|ucfirst }}() as $embedded) {
            $this->addResource('{{ name }}', $this->create{{ name|ucfirst }}EmbeddedResource($embedded));
        }

{% endfor %}
    }

    protected function setLinksFromDocument(\{{ class }} $document)
    {
{# referencesOne #}
{% for name, config in config_class.referencesOne %}
        $referenced = $document->get{{ name|ucfirst }}();
        if ($referenced) {
            $uri = $this->getRepository('{{ extension.getRepositoryKey(name) }}')->getDocumentURI($referenced);
            $link = new \Level3\Resource\Link($uri);
            $this->addLink('{{ name }}', $link);
        }

{% endfor %}
{# referencesMany #}
{% for name, config in config_class.referencesMany %}
        $repository = $this->getRepository('{{ extension.getRepositoryKey(name) }}');
        foreach ($document->get{{ name|ucfirst }}() as $referenced) {
            $uri = $repository->getDocumentURI($referenced);
            $link = new \Level3\Resource\Link($uri);
            $this->addLink('{{ name }}', $link);
        }

{% endfor %}
    }

    protected function getRepository($repositoryKey)
    {
        return $this->level3->getHub()->get($repositoryKey);
    }

    public function fromRequest(Array $data)
    {
{% for name in config_class.fields|keys %}
{% if config_class.fields[name].type  == 'date' %}
        if (isset($data['{{ name }}'])) {
            $data['{{ name }}'] = $this->types->fromRequest('DateTime', $data['{{ name }}']);
        }
{% endif %}
{% endfor %}

{# referencesOne #}
{% for name in config_class.referencesOne|keys %}
        if (isset($data['{{ name }}'])) {
            $data['{{ name }}_reference_field'] = $this->types->fromRequest('MongoId', $data['{{ name }}']);
            unset($data['{{ name }}']);
        }
{% endfor %}

        return $data;
    }

{% set embeddeds = config_class.embeddedsOne|merge(config_class.embeddedsMany) %}
{% for name, config in embeddeds %}
    protected function create{{ name|ucfirst }}EmbeddedResource(\{{ config.class }} $document)
    {
{% if extension.isRepositoryNeeded(config.class) %}
        $repository = $this->level3->getHub()->get('{{ extension.getRepositoryKey(config.class)}}');
        $resource = $repository->createDocumentResource($document);
{% else %}
        $resource = new \{{ extension.getResourceClassName(config.class) }}($this->level3);
        $resource->fromDocument($document);
{% endif %}

        return $resource;
    }

{% endfor %}